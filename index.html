<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>RetinaCCTV Pro System</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --primary: #4361ee; --primary-soft: rgba(67, 97, 238, 0.25); --secondary: #858796; --success: #2ec4b6; --success-soft: rgba(46, 196, 182, 0.25); --warning: #ff9f1c; --warning-soft: rgba(255, 159, 28, 0.25); --danger: #e71d36; --danger-soft: rgba(231, 29, 54, 0.25); --dark: #0b0f19; --bg-body: #f4f7fe; --sidebar-bg: #111c44; --card-shadow: 0 5px 20px 0 rgba(0, 0, 0, 0.05); --font-main: 'Poppins', sans-serif; --sidebar-width: 260px; }
    body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--dark); overflow-x: hidden; font-size: 0.95rem; }
    .dataTables_length select { padding-right: 35px !important; background-position: right 0.5rem center !important; min-width: 80px; }
    #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary) 0%, #3f37c9 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    .login-card { background: white; width: 900px; height: 550px; display: flex; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    .login-img-container { width: 50%; background-color: #f8faff; display: flex; justify-content: center; align-items: center; padding: 60px; }
    .actual-login-img { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 8px 16px rgba(67, 97, 238, 0.1)); }
    .login-form { width: 50%; padding: 60px; display: flex; flex-direction: column; justify-content: center; }
    .login-form .form-control { border-radius: 12px; padding: 12px 15px; border: 1px solid #e0e6ed; background-color: #fcfdff; }
    .login-form .form-control:focus { box-shadow: 0 0 0 3px var(--primary-soft); border-color: var(--primary); }
    #sidebar { width: var(--sidebar-width); min-height: 100vh; background: var(--sidebar-bg); position: fixed; z-index: 1000; transition: all 0.3s ease; left: 0; top: 0; }
    .sidebar-brand-wrapper { padding: 30px 20px; color: white; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center; overflow: hidden; white-space: nowrap;}
    .sidebar-main-title { font-size: 1.5rem; font-weight: 800; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 12px; color: white; }
    .watermark-text { font-family: 'Poppins', sans-serif; font-size: 10px; font-weight: 400; text-transform: none; opacity: 0.5; margin-top: 5px; letter-spacing: 1px; color: white; text-align: center; white-space: nowrap; }
    .nav-item { padding: 0 15px; margin-top: 10px; }
    .nav-link { color: rgba(255,255,255,0.7); padding: 12px 18px; border-radius: 12px; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 15px; font-size: 0.95rem; white-space: nowrap; overflow: hidden; cursor: pointer; }
    .nav-link i { font-size: 1.1rem; width: 24px; text-align: center; flex-shrink: 0; }
    .nav-link:hover { color: white; background: rgba(255,255,255,0.05); transform: translateX(3px); }
    .nav-link.active { background: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3); }
    #content { margin-left: var(--sidebar-width); padding: 30px 40px; min-height: 100vh; transition: all 0.3s ease; }
    body.sb-collapsed #sidebar { width: 80px; }
    body.sb-collapsed #content { margin-left: 80px; }
    body.sb-collapsed .link-text, body.sb-collapsed .watermark-text, body.sb-collapsed .sidebar-title-text { display: none !important; }
    body.sb-collapsed .sidebar-brand-wrapper { padding: 20px 5px; }
    body.sb-collapsed .nav-link { justify-content: center; padding: 15px 0; }
    body.sb-collapsed .nav-link i { margin: 0 !important; font-size: 1.3rem; }
    @media (max-width: 992px) {
        #sidebar { left: -260px; }
        #content { margin-left: 0; padding: 20px; width: 100%; }
        body.sb-active #sidebar { left: 0; }
        body.sb-active .sidebar-overlay { display: block; }
    }
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    .card-pro { background: white; border: none; border-radius: 20px; box-shadow: var(--card-shadow); padding: 25px; margin-bottom: 25px; transition: transform 0.3s, box-shadow 0.3s; }
    .stat-card { background: white; border-radius: 20px; padding: 25px; box-shadow: var(--card-shadow); display: flex; align-items: center; justify-content: space-between; transition: 0.3s; border: 1px solid transparent; }
    .stat-card .card-data h2 { font-weight: 800; margin: 0; font-size: 1.8rem; color: var(--dark); }
    .stat-card .card-data p { margin: 0; color: var(--secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .stat-card .card-icon { width: 65px; height: 65px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; }
    .stat-card.blue .card-icon { background: var(--primary-soft); color: var(--primary); }
    .stat-card.green .card-icon { background: var(--success-soft); color: var(--success); }
    .stat-card.orange .card-icon { background: var(--warning-soft); color: var(--warning); }
    .stat-card.red .card-icon { background: var(--danger-soft); color: var(--danger); }
    .stat-card.purple { background: linear-gradient(45deg, #6f42c1, #4361ee); }
    .asset-card { background: white; border-radius: 20px; padding: 30px; box-shadow: var(--card-shadow); position: relative; overflow: hidden; background-clip: padding-box; border: 2px solid transparent; position: relative; }
    .asset-card::before { content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; z-index: -1; margin: -2px; border-radius: inherit; background: linear-gradient(45deg, #6f42c1, #4361ee); }
    .asset-card .card-icon-lg { position: absolute; right: 25px; top: 50%; transform: translateY(-50%) rotate(-15deg); font-size: 6rem; opacity: 0.3; color: #6f42c1; }
    .btn-grad { background: var(--primary); color: white; border: none; font-weight: 600; padding: 12px 30px; border-radius: 12px; box-shadow: 0 4px 15px var(--primary-soft); transition: 0.3s; }
    .btn-grad:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--primary-soft); color: white; }
    .form-control, .form-select { border-radius: 12px; padding: 12px; border: 1px solid #e0e6ed; background-color: #fcfdff; }
    .form-control:focus, .form-select:focus { box-shadow: 0 0 0 3px var(--primary-soft); border-color: var(--primary); }
    .table-responsive-custom { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table-custom { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; white-space: nowrap; }
    .table-custom thead tr th { background-color: #f8faff !important; color: var(--secondary) !important; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; padding: 15px 20px; border-bottom: 2px solid #e0e6ed; }
    .table-custom tbody tr td { padding: 20px; vertical-align: middle; border-bottom: 1px solid #f0f4f8; color: var(--dark); background-color: white !important; }
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 10000; display: none; justify-content: center; align-items: center; }
    #sidebarToggle { background: white; border: none; color: var(--primary); width: 45px; height: 45px; border-radius: 12px; box-shadow: var(--card-shadow); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    #sidebarToggle:hover { transform: scale(1.05); }
    #print-area { display: none; }
        @media print { body > *:not(#print-area) { display: none !important; } body { margin: 0; padding: 0; background-color: white !important; } #print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 30px !important; background-color: white !important; } .kop-table { width: 100%; border-bottom: 3px solid black; margin-bottom: 20px; padding-bottom: 10px; } .kop-logo-cell { width: 15%; text-align: center; vertical-align: middle; } .kop-logo-img { width: 100px; height: auto; } .kop-text-cell { width: 85%; text-align: center; vertical-align: middle; } .kop-title { font-size: 24px; font-weight: 900; text-transform: uppercase; margin: 0; letter-spacing: 1px; } .kop-subtitle { font-size: 14px; font-weight: bold; margin: 2px 0; text-transform: uppercase; color: #333; } .kop-address { font-size: 11px; margin: 0; line-height: 1.4; color: #000; } .report-header { text-align: center; margin: 20px 0; } .report-title { font-size: 18px; text-decoration: underline; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; } .print-table { width: 100%; border-collapse: collapse !important; margin-top: 15px; font-size: 11px; } .print-table th { background-color: #4e73df !important; color: white !important; border: 1px solid black !important; padding: 8px; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .print-table td { border: 1px solid black !important; padding: 6px; color: black !important; } .signature-section { margin-top: 50px; width: 100%; display: flex; justify-content: flex-end; } .sign-box { width: 250px; text-align: center; font-size: 12px; } }
  </style>
</head>
<body>

  <div id="loader"><div class="text-center"><div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div><p class="mt-3 fw-bold text-dark">Memuat Sistem...</p></div></div>

  <div id="login-wrapper">
    <div class="login-card animate__animated animate__fadeInUp">
      <div class="login-img-container"><img src="https://retinacctv.id/wp-content/uploads/2025/06/1.-PNG2.png" alt="Logo" class="actual-login-img"></div>
      <div class="login-form">
        <h2 class="fw-bold mb-2 text-dark display-6">Welcome Back!</h2><p class="text-muted mb-5">Silakan masuk ke Sistem Inventory RetinaCCTV.</p>
        <div class="form-floating mb-3"><input type="text" class="form-control" id="uName" placeholder="U"><label>Username</label></div>
        <div class="form-floating mb-4"><input type="password" class="form-control" id="uPass" placeholder="P"><label>Password</label></div>
        <button onclick="doLogin()" class="btn btn-primary w-100 py-3 rounded-4 fw-bold fs-5" style="background: var(--primary); border:none;">LOGIN SEKARANG</button>
      </div>
    </div>
  </div>

  <div id="main-app" style="display:none;">
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <nav id="sidebar">
      <div class="sidebar-brand-wrapper">
        <div class="sidebar-main-title"><i class="fas fa-shield-alt"></i> <span class="sidebar-title-text ms-2">RetinaCCTV</span></div>
        <div class="watermark-text text-center text-white-50 mt-2">Made By Syafiqsrgr</div>
      </div>
      <div class="px-3">
        <div class="nav-item"><div onclick="nav('dashboard',this)" class="nav-link active"><i class="fas fa-home"></i> <span class="link-text">Dashboard</span></div></div>
        <div class="nav-item"><div onclick="nav('barang',this)" class="nav-link"><i class="fas fa-boxes"></i> <span class="link-text">Master Barang</span></div></div>
        <div class="nav-item"><div onclick="nav('masuk',this)" class="nav-link"><i class="fas fa-arrow-circle-down"></i> <span class="link-text">Barang Masuk</span></div></div>
        <div class="nav-item"><div onclick="nav('keluar',this)" class="nav-link"><i class="fas fa-arrow-circle-up"></i> <span class="link-text">Barang Keluar</span></div></div>
        <div class="nav-item mt-4"><div onclick="nav('supplier',this)" class="nav-link"><i class="fas fa-truck"></i> <span class="link-text">Data Supplier</span></div></div>
        <div class="nav-item"><div onclick="nav('kategori',this)" class="nav-link"><i class="fas fa-tags"></i> <span class="link-text">Kategori Produk</span></div></div>
      </div>
      <div class="nav-item px-3 mt-5 pt-5"><div onclick="location.reload()" class="nav-link text-danger bg-danger-soft"><i class="fas fa-sign-out-alt"></i> <span class="link-text">Keluar</span></div></div>
    </nav>

    <div id="content">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <div class="d-flex align-items-center"><button id="sidebarToggle" onclick="toggleSidebar()" class="me-3"><i class="fas fa-bars"></i></button><div><h4 class="fw-bold mb-0 text-dark d-none d-sm-block">Inventory System</h4></div></div>
        <div><span class="badge bg-white text-dark shadow-sm p-2"><i class="fas fa-user-circle me-1"></i> Admin</span></div>
      </div>

      <div id="view-dashboard" class="view-section animate__animated animate__fadeIn">
        <div class="row mb-4"><div class="col-12"><div class="asset-card d-flex align-items-center justify-content-between"><div style="z-index: 2;"><p class="mb-2 text-primary fw-bold text-uppercase" style="letter-spacing: 1px;">Estimasi Total Nilai Aset</p><h1 class="fw-bolder mb-0 display-5 text-dark" id="d-aset">Rp 0</h1><p class="text-muted mt-2 mb-0 small"><i class="fas fa-info-circle me-1"></i> Dihitung dari (Jumlah Stok x Harga Beli)</p></div><div class="card-icon-lg"><i class="fas fa-coins"></i></div></div></div></div>
        <div class="row g-4 mb-5">
          <div class="col-6 col-md-3"><div class="stat-card blue"><div class="card-data"><p>Total Item</p><h2 id="d-brg">0</h2></div><div class="card-icon"><i class="fas fa-box"></i></div></div></div>
          <div class="col-6 col-md-3"><div class="stat-card green"><div class="card-data"><p>Total Stok</p><h2 id="d-stok">0</h2></div><div class="card-icon"><i class="fas fa-layer-group"></i></div></div></div>
          <div class="col-6 col-md-3"><div class="stat-card orange"><div class="card-data"><p>Masuk</p><h2 id="d-masuk">0</h2></div><div class="card-icon"><i class="fas fa-download"></i></div></div></div>
          <div class="col-6 col-md-3"><div class="stat-card red"><div class="card-data"><p>Keluar</p><h2 id="d-keluar">0</h2></div><div class="card-icon"><i class="fas fa-upload"></i></div></div></div>
        </div>
        <div class="row g-4"><div class="col-md-8"><div class="card-pro h-100"><h5 class="fw-bold text-dark mb-0">Tren Stok</h5><div style="height:250px"><canvas id="chartTren"></canvas></div></div></div><div class="col-md-4"><div class="card-pro h-100"><h5 class="fw-bold text-dark mb-4">Kategori</h5><div style="height:200px"><canvas id="chartKat"></canvas></div></div></div></div>
      </div>

      <div id="view-barang" class="view-section" style="display:none;">
        <div class="card-pro">
          <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom flex-wrap gap-2">
            <h4 class="fw-bold text-dark mb-0">Stok Barang</h4>
            <div class="d-flex gap-2"><button class="btn btn-outline-danger btn-sm" onclick="printLaporan('Barang')"><i class="fas fa-print"></i></button><button class="btn-grad btn-sm" onclick="modalShow('Barang')"><i class="fas fa-plus"></i> Tambah</button></div>
          </div>
          <div class="table-responsive-custom"><table id="tbl-barang" class="table table-custom table-hover w-100"><thead><tr><th>Kode</th><th>Nama Barang</th><th>Kategori</th><th>Stok & Satuan</th><th>Harga Jual</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
        </div>
      </div>

      <div id="view-masuk" class="view-section" style="display:none;">
        <h4 class="fw-bold text-dark mb-3">Barang Masuk</h4>
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card-pro border-0 bg-warning-subtle">
              <h5 class="fw-bold mb-3 text-warning-emphasis">Input Masuk</h5>
              <div class="mb-3 bg-white p-2 rounded shadow-sm"><input type="text" id="scan-masuk" class="form-control border-0" placeholder="1. Scan Barcode PN..." onchange="handleScan('Masuk',this.value)"></div>
              <form id="formMasuk" class="d-grid gap-2" onsubmit="event.preventDefault(); simpanTrx('Masuk');">
                <select id="in-brg" class="form-select form-select-sm"></select>
                <select id="in-sup" class="form-select form-select-sm"><option value="-">Umum</option></select>
                <input type="text" id="in-sn" class="form-control form-select-sm" placeholder="2. Scan SN (Wajib)">
                <input type="number" id="in-jml" class="form-control form-select-sm text-center fw-bold bg-white" value="1" readonly>
                <button type="submit" class="btn btn-warning fw-bold">SIMPAN (Enter)</button>
              </form>
            </div>
          </div>
          <div class="col-md-8"><div class="card-pro"><div class="d-flex justify-content-between mb-3"><h5 class="fw-bold">Riwayat</h5><button class="btn btn-sm btn-light" onclick="printLaporan('Masuk')"><i class="fas fa-print"></i></button></div><div class="table-responsive-custom"><table id="tbl-masuk" class="table table-custom w-100"><thead><tr><th>Tgl</th><th>Barang</th><th>Supp</th><th>Jml</th><th>SN</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div></div>
        </div>
      </div>

      <div id="view-keluar" class="view-section" style="display:none;">
        <h4 class="fw-bold text-dark mb-3">Barang Keluar</h4>
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card-pro border-0 bg-danger-subtle">
              <h5 class="fw-bold mb-3 text-danger-emphasis">Input Keluar</h5>
              <div class="mb-3 bg-white p-2 rounded shadow-sm border border-danger">
                  <label class="small fw-bold text-danger">1. Scan Serial Number (SN)</label>
                  <input type="text" id="scan-keluar-sn" class="form-control border-0 fw-bold" placeholder="Scan SN di sini..." onchange="cekSNKeluar(this.value)" autofocus>
              </div>
              <form id="formKeluar" class="d-grid gap-2" onsubmit="event.preventDefault(); simpanTrx('Keluar');">
                <div class="mb-1"><label class="small text-muted">Barang:</label><select id="out-brg" class="form-select form-select-sm" disabled></select></div>
                <div class="mb-1"><label class="small text-muted">Asal Supplier:</label><input type="text" id="out-supp-display" class="form-control form-select-sm fw-bold" readonly disabled placeholder="-"></div>
                <div class="mb-1">
                    <label class="small text-muted">Status:</label>
                    <select id="out-ket" class="form-select form-select-sm">
                        <option value="Jual">Jual</option>
                        <option value="Instalasi">Instalasi</option>
                        <option value="Demo">Demo</option>
                    </select>
                </div>
                <input type="hidden" id="out-sn">
                <input type="number" id="out-jml" class="form-control form-select-sm text-center fw-bold bg-white" value="1" readonly>
                <button type="submit" class="btn btn-danger text-white fw-bold">SIMPAN (Enter)</button>
              </form>
            </div>
          </div>
          <div class="col-md-8"><div class="card-pro"><div class="d-flex justify-content-between mb-3"><h5 class="fw-bold">Riwayat</h5><button class="btn btn-sm btn-light" onclick="printLaporan('Keluar')"><i class="fas fa-print"></i></button></div><div class="table-responsive-custom"><table id="tbl-keluar" class="table table-custom w-100"><thead><tr><th>Tgl</th><th>Barang</th><th>Supplier</th><th>Ket</th><th>Jml</th><th>SN</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div></div>
        </div>
      </div>

      <div id="view-supplier" class="view-section" style="display:none;"><div class="card-pro"><div class="d-flex justify-content-between mb-3"><h4 class="fw-bold">Data Supplier</h4><button class="btn-grad" onclick="modalShow('Supplier')">Tambah</button></div><div class="table-responsive-custom"><table id="tbl-supplier" class="table table-custom w-100"><thead><tr><th>Nama</th><th>Alamat</th><th>Telp</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div></div>
      <div id="view-kategori" class="view-section" style="display:none;"><div class="card-pro"><div class="d-flex justify-content-between mb-3"><h4 class="fw-bold">Kategori</h4><button class="btn-grad" onclick="modalShow('Kategori')">Tambah</button></div><div class="table-responsive-custom"><table id="tbl-kategori" class="table table-custom w-100"><thead><tr><th>ID</th><th>Nama</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div></div>
    </div>
  </div>

  <div class="modal fade" id="mainModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content border-0 shadow-lg rounded-4"><div class="modal-header border-0 p-4"><h5 class="modal-title fw-bolder text-primary fs-4" id="modalTitle">Form</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4 pt-0" id="modalBody"></div><div class="modal-footer border-0 p-4"><input type="hidden" id="editId"><input type="hidden" id="editType"><button type="button" class="btn btn-light rounded-pill btn-sm" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-grad rounded-pill btn-sm" id="btnSaveModal">Simpan</button></div></div></div></div>

  <div id="print-area"><table class="kop-table"><tr><td class="kop-logo-cell"><img src="https://retinacctv.id/wp-content/uploads/2025/06/1.-PNG2.png" alt="Logo" class="kop-logo-img"></td><td class="kop-text-cell"><h1 class="kop-title">CV RETINA PERISAI NUSANTARA</h1><h3 class="kop-subtitle">Professional Security System Provider</h3><p class="kop-address">Jl Komplek Unilever Blok C No.2A RT/RW 002/006 Karang Mulya, Karang Tengah, Tangerang, 15157<br>Website : retinacctv.id | Email : retinacctv@gmail.com | No Hp : 0812-9746-0115</p></td></tr></table><div class="report-header"><h3 id="print-title" class="report-title">LAPORAN</h3><p class="report-date">Dicetak pada: <span id="print-date"></span></p></div><table class="print-table"><thead id="print-head"></thead><tbody id="print-body"></tbody></table><div class="signature-section"><div class="sign-box"><p>Tangerang, <span id="print-sign-date"></span></p><p>Mengetahui,</p><br><br><br><p style="font-weight: bold; text-decoration: underline;">Administrator</p></div></div></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    let gBarang=[],gMasuk=[],gKeluar=[],gKat=[],gSuppliers=[],chart1=null,chart2=null,isEditMode=false;
    function toggleSidebar(){ if(window.innerWidth<=992){document.body.classList.toggle('sb-active')}else{document.body.classList.toggle('sb-collapsed')} }
    function nav(v,el){$('.view-section').hide();$('#view-'+v).fadeIn();$('.nav-link').removeClass('active');$(el).addClass('active');if(window.innerWidth<=992)document.body.classList.remove('sb-active');if(v==='masuk')$('#scan-masuk').focus();if(v==='keluar')$('#scan-keluar-sn').focus();}
    $.extend(true,$.fn.dataTable.defaults,{"language":{"search":"","searchPlaceholder":"Cari...","lengthMenu":"_MENU_","info":"_START_-_END_ / _TOTAL_"},"dom":'<"d-flex justify-content-between align-items-center mb-3"lf>rt<"d-flex justify-content-between align-items-center mt-3"ip>'});
    function doLogin(){$('#loader').css('display','flex');google.script.run.withSuccessHandler(r=>{$('#loader').hide();if(r.status==='success'){$('#login-wrapper').fadeOut();$('#main-app').fadeIn();loadAll();Chart.defaults.font.family="'Poppins',sans-serif";}else Swal.fire({icon:'error',title:'Gagal'})}).checkLogin($('#uName').val(),$('#uPass').val())}
    function loadAll(){google.script.run.withSuccessHandler(d=>{$('#d-brg').text(d.jmlBarang);$('#d-stok').text(d.jmlStok);$('#d-masuk').text(d.jmlMasuk);$('#d-keluar').text(d.jmlKeluar);$('#d-aset').text(new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(d.totalAset));if(chart1)chart1.destroy();chart1=new Chart(document.getElementById('chartTren'),{type:'line',data:{labels:['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Ags','Sep','Okt','Nov','Des'],datasets:[{label:'Masuk',data:d.chartTren.masuk,borderColor:'#4361ee',backgroundColor:'rgba(67,97,238,0.1)',fill:true,tension:0.4},{label:'Keluar',data:d.chartTren.keluar,borderColor:'#e71d36',backgroundColor:'rgba(231,29,54,0.1)',fill:true,tension:0.4}]},options:{maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true,grid:{color:'#f0f4f8'}},x:{grid:{display:false}}}}});if(chart2)chart2.destroy();chart2=new Chart(document.getElementById('chartKat'),{type:'doughnut',data:{labels:Object.keys(d.chartKategori),datasets:[{data:Object.values(d.chartKategori),backgroundColor:['#4361ee','#2ec4b6','#ff9f1c','#e71d36','#6f42c1'],borderWidth:0}]},options:{maintainAspectRatio:false,plugins:{legend:{position:'bottom'}},cutout:'70%'}});loadTable('Barang','#tbl-barang');loadTable('Supplier','#tbl-supplier');loadTable('Kategori','#tbl-kategori');loadTable('Masuk','#tbl-masuk');loadTable('Keluar','#tbl-keluar')}).getChartData()}
    
    // LOAD TABLE (FIXED COLUMN COUNTS)
    function loadTable(t,id){google.script.run.withSuccessHandler(d=>{if($.fn.DataTable.isDataTable(id))$(id).DataTable().destroy();let h='';try{if(t==='Barang'){gBarang=d;d.forEach(r=>{let k=r[0]||'',n=r[1]||'',c=r[2]||'',st=Number(r[6])||0,j=Number(r[5])||0;h+=`<tr><td><span class="badge bg-primary-soft text-primary">${k}</span></td><td class="fw-bold">${n}</td><td>${c}</td><td><span class="fw-bold ${st>0?'text-success':'text-danger'}">${st}</span> <small>${r[3]||''}</small></td><td>Rp ${j.toLocaleString()}</td><td><button class="btn btn-sm btn-outline-warning rounded-circle me-1" onclick="editData('Barang','${k}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger rounded-circle" onclick="hapus('Barang','${k}')"><i class="fas fa-trash-alt"></i></button></td></tr>`})}else if(t==='Masuk'){gMasuk=d;d.forEach(r=>{h+=`<tr><td><small>${r[1]}</small></td><td class="fw-bold">${r[3]}</td><td>${r[4]}</td><td><span class="badge bg-success-soft text-success">+${r[5]}</span></td><td><span class="font-monospace small">${r[6]||'-'}</span></td><td><button class="btn btn-sm btn-outline-warning rounded-circle me-1" onclick="editData('Masuk','${r[0]}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger rounded-circle" onclick="hapus('Masuk','${r[0]}')"><i class="fas fa-trash-alt"></i></button></td></tr>`})}
    else if(t==='Keluar'){gKeluar=d;d.forEach(r=>{h+=`<tr><td><small>${r[1]}</small></td><td class="fw-bold">${r[3]}</td><td>${r[4]||'-'}</td><td>${r[5]||'-'}</td><td><span class="badge bg-danger-soft text-danger">-${r[6]}</span></td><td><span class="font-monospace small">${r[7]||'-'}</span></td><td><button class="btn btn-sm btn-outline-warning rounded-circle me-1" onclick="editData('Keluar','${r[0]}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger rounded-circle" onclick="hapus('Keluar','${r[0]}')"><i class="fas fa-trash-alt"></i></button></td></tr>`})}
    else if(t==='Supplier'){gSuppliers=d;d.forEach(r=>{h+=`<tr><td class="fw-bold">${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td><button class="btn btn-sm btn-outline-warning me-1" onclick="editData('Supplier','${r[0]}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="hapus('Supplier','${r[0]}')"><i class="fas fa-trash-alt"></i></button></td></tr>`});let o='<option value="-">Umum</option>'+d.map(r=>`<option value="${r[1]}">${r[1]}</option>`).join('');$('#in-sup').html(o)}else if(t==='Kategori'){gKat=d;d.forEach(r=>{h+=`<tr><td><span class="badge bg-light text-dark border">${r[0]}</span></td><td class="fw-bold">${r[1]}</td><td><button class="btn btn-sm btn-outline-warning me-1" onclick="editData('Kategori','${r[0]}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="hapus('Kategori','${r[0]}')"><i class="fas fa-trash-alt"></i></button></td></tr>`})}}catch(e){} $(id+' tbody').html(h); $(id).DataTable({pageLength:5,lengthMenu:[5,10,25],order:[[0,'desc']]}); if(t==='Barang') updateDrop()}).getData(t)}
    function updateDrop(){let o='<option value="" disabled selected>-- Pilih Barang --</option>';gBarang.forEach(b=>{let s=Number(b[6])||0;let cls=s>0?'text-success':'text-danger';o+=`<option value="${b[0]}" data-nama="${b[1]}" class="${cls}">${b[0]} - ${b[1]} (Stok: ${s})</option>`});$('#in-brg,#out-brg').html(o)}
    
    function handleScan(t,k){
        if(!k)return;
        let p=t==='Masuk'?'in':'out';
        let f = gBarang.find(i=> String(i[0]).trim().toLowerCase() === String(k).trim().toLowerCase());
        if(f){
            $('#'+p+'-brg').val(f[0]).change();
            $('#scan-'+t.toLowerCase()).val('').addClass('is-valid');
            setTimeout(()=>$('#scan-'+t.toLowerCase()).removeClass('is-valid'),1000);
            if(t==='Masuk'){ $('#in-sup').focus(); }
        } else {
            Swal.fire({icon:'error',title:'Tidak Ditemukan', text:'Kode Barang tidak ada di Master.'});
            $('#scan-'+t.toLowerCase()).val('').addClass('is-invalid');
        }
    }

    function cekSNKeluar(sn){
        if(!sn) return;
        google.script.run.withSuccessHandler(function(res){
            if(res.status === 'success'){
                $('#out-brg').val(res.kode).change();
                $('#out-sn').val(sn); 
                $('#out-supp-display').val(res.supplier); 
                $('#scan-keluar-sn').addClass('is-valid');
                $('#out-ket').focus();
            } else {
                Swal.fire({icon:'error', title:'Gagal', text: res.msg});
                $('#scan-keluar-sn').val('').addClass('is-invalid');
            }
        }).cariBarangBySN(sn);
    }

    function editData(type,id){isEditMode=true;$('#editId').val(id);$('#editType').val(type);let data;if(type==='Barang')data=gBarang.find(r=>r[0]==id);else if(type==='Supplier')data=gSuppliers.find(r=>r[0]==id);else if(type==='Kategori')data=gKat.find(r=>r[0]==id);else if(type==='Masuk')data=gMasuk.find(r=>r[0]==id);else if(type==='Keluar')data=gKeluar.find(r=>r[0]==id);if(!data)return;modalShow(type,true);$('#btnSaveModal').text('Update').removeClass('btn-grad').addClass('btn-warning text-dark');setTimeout(()=>{if(type==='Barang'){$('#mId').val(data[0]).prop('disabled',true);$('#mNama').val(data[1]);$('#mKat').val(data[2]);$('#mSat').val(data[3]);$('#mBeli').val(data[4]);$('#mJual').val(data[5]);$('#mStok').val(data[6]).prop('disabled',true)}else if(type==='Supplier'){$('#sNama').val(data[1]);$('#sAlamat').val(data[2]);$('#sTelp').val(data[3])}else if(type==='Kategori'){$('#kNama').val(data[1])}else if(type==='Masuk'||type==='Keluar'){$('#tId').val(data[0]).prop('disabled',true);$('#tNama').val(data[3]).prop('disabled',true);$('#tJml').val(data[5]).prop('disabled',true);$('#tKet').val(data[4]);$('#tSn').val(data[6])}},300)}
    
    function modalShow(t,isEdit=false){$('#modalTitle').text(isEdit?'Edit '+t:'Tambah '+t);if(!isEdit){isEditMode=false;$('#editId').val('');$('#editType').val('');$('#btnSaveModal').text('Simpan').addClass('btn-grad').removeClass('btn-warning text-dark')}let h='';
    if(t==='Barang'){let k=gKat.map(x=>`<option>${x[1]}</option>`).join('');h=`<div class="row g-2"><div class="col-4"><label class="small fw-bold">Kode</label><input id="mId" class="form-control"></div><div class="col-8"><label class="small fw-bold">Nama</label><input id="mNama" class="form-control"></div><div class="col-12"><label class="small fw-bold">Kategori</label><select id="mKat" class="form-select">${k}</select></div><div class="col-4"><label class="small fw-bold">Satuan</label><input id="mSat" class="form-control"></div><div class="col-4"><label class="small fw-bold">Beli</label><input type="number" id="mBeli" class="form-control"></div><div class="col-4"><label class="small fw-bold">Jual</label><input type="number" id="mJual" class="form-control"></div><div class="col-12"><label class="small fw-bold">Stok Awal</label><input type="number" id="mStok" class="form-control" value="0"></div></div>`}
    else if(t==='Supplier')h=`<div class="mb-2"><label class="small fw-bold">Nama</label><input id="sNama" class="form-control"></div><div class="mb-2"><label class="small fw-bold">Alamat</label><textarea id="sAlamat" class="form-control"></textarea></div><div class="mb-2"><label class="small fw-bold">Telepon</label><input id="sTelp" class="form-control"></div>`;else if(t==='Kategori')h=`<div class="mb-2"><label class="small fw-bold">Nama Kategori</label><input id="kNama" class="form-control"></div>`;else if(t==='Masuk'||t==='Keluar'){h=`<div class="mb-2"><label class="small fw-bold">ID Transaksi</label><input id="tId" class="form-control"></div><div class="mb-2"><label class="small fw-bold">Nama</label><input id="tNama" class="form-control"></div><div class="mb-2"><label class="small fw-bold">Jumlah</label><input id="tJml" class="form-control" readonly></div><div class="mb-2"><label class="small fw-bold">${t==='Masuk'?'Supplier':'Ket'}</label><input id="tKet" class="form-control"></div><div class="mb-2"><label class="small fw-bold">SN</label><input id="tSn" class="form-control"></div>`} $('#modalBody').html(h);$('#btnSaveModal').off().click(()=>simpanMaster(t));$('#mainModal').modal('show')}
    
    function simpanMaster(t){let d={};if(isEditMode){let id=$('#editId').val();if(t==='Barang')d={nama:$('#mNama').val(),kategori:$('#mKat').val(),satuan:$('#mSat').val(),beli:$('#mBeli').val(),jual:$('#mJual').val()};else if(t==='Supplier')d={nama:$('#sNama').val(),alamat:$('#sAlamat').val(),telepon:$('#sTelp').val()};else if(t==='Kategori')d={nama:$('#kNama').val()};else if(t==='Masuk'||t==='Keluar')d={keterangan:$('#tKet').val(),sn:$('#tSn').val()};Swal.fire({title:'Mengupdate...',didOpen:()=>Swal.showLoading()});google.script.run.withSuccessHandler(r=>{if(r.status==='success'){$('#mainModal').modal('hide');Swal.fire({icon:'success',title:'Updated!',timer:1000,showConfirmButton:false});loadTable(t,'#tbl-'+t.toLowerCase())}else Swal.fire('Gagal',r.msg,'error')}).updateData(t,id,d)}else{if(t==='Barang')d={id:$('#mId').val(),nama:$('#mNama').val(),kategori:$('#mKat').val(),satuan:$('#mSat').val(),beli:$('#mBeli').val(),jual:$('#mJual').val(),stok:$('#mStok').val()};else if(t==='Supplier')d={nama:$('#sNama').val(),alamat:$('#sAlamat').val(),telepon:$('#sTelp').val()};else if(t==='Kategori')d={nama:$('#kNama').val()};if(t==='Barang'&&!d.nama)return Swal.fire({icon:'warning',title:'Nama Wajib'});Swal.fire({title:'Menyimpan...',didOpen:()=>Swal.showLoading()});google.script.run.withSuccessHandler(r=>{if(r.status==='success'){$('#mainModal').modal('hide');Swal.fire({icon:'success',title:'Tersimpan!',timer:1000,showConfirmButton:false});loadTable(t,'#tbl-'+t.toLowerCase())}else Swal.fire('Gagal',r.msg,'error')}).simpanData(t,d)}}
    
    function simpanTrx(t){
        let p=t==='Masuk'?'in':'out';
        let snVal = (t==='Keluar') ? $('#out-sn').val() : $('#in-sn').val();
        let o={
            kodeBrg:$('#'+p+'-brg').val(),
            namaBrg:$('#'+p+'-brg option:selected').data('nama'),
            keterangan:t==='Masuk'?$('#in-sup').val():$('#out-ket').val(),
            jumlah:1,
            sn: snVal || '-',
            supplier: (t==='Keluar') ? $('#out-supp-display').val() : '' 
        };
        if(!o.kodeBrg) return Swal.fire({icon:'warning',title:'Pilih Barang Dulu'});
        Swal.fire({title:'Menyimpan...',didOpen:()=>Swal.showLoading()});
        google.script.run.withSuccessHandler(r=>{
            if(r.status==='success'){
                Swal.fire({icon:'success',title:'Berhasil!',timer:1000,showConfirmButton:false});
                let lastSupplier = $('#in-sup').val();
                $('form').trigger('reset');
                $('#'+p+'-jml').val(1);
                if(t==='Masuk'){ $('#in-sup').val(lastSupplier); $('#scan-masuk').focus(); }
                if(t==='Keluar'){ $('#scan-keluar-sn').val('').focus(); $('#out-brg').val('').change(); $('#out-supp-display').val(''); }
                loadTable(t,'#tbl-'+t.toLowerCase());
                loadTable('Barang','#tbl-barang');
                google.script.run.withSuccessHandler(d=>{$('#d-stok').text(d.jmlStok);$('#d-aset').text(new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(d.totalAset))}).getChartData();
            } else { Swal.fire({icon:'error',title:'Gagal',text:r.msg}); }
        }).simpanTransaksi(t,o);
    }
    
    function hapus(t,id){Swal.fire({title:'Hapus?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed){Swal.fire({title:'Menghapus...',didOpen:()=>Swal.showLoading()});google.script.run.withSuccessHandler(()=>{loadTable(t,'#tbl-'+t.toLowerCase());Swal.fire({icon:'success',title:'Terhapus!',timer:1000,showConfirmButton:false})}).hapusData(t,id)}})}
    function printLaporan(j){let today=new Date();$('#print-date').text(today.toLocaleDateString('id-ID',{weekday:'long',year:'numeric',month:'long',day:'numeric'}));$('#print-sign-date').text(today.toLocaleDateString('id-ID',{year:'numeric',month:'long',day:'numeric'}));let h='',b='';if(j==='Barang'){$('#print-title').text('LAPORAN STOK GUDANG');h='<tr><th>Kode</th><th>Barang</th><th>Kategori</th><th>Stok</th></tr>';gBarang.forEach(r=>{b+=`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[6]} ${r[3]}</td></tr>`})}else if(j==='Masuk'){$('#print-title').text('LAPORAN PEMASUKAN BARANG');h='<tr><th>Tanggal</th><th>Barang</th><th>Supplier</th><th>Jml</th><th>SN</th></tr>';gMasuk.forEach(r=>{b+=`<tr><td>${r[1]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]||'-'}</td></tr>`})}else if(j==='Keluar'){$('#print-title').text('LAPORAN PENGELUARAN BARANG');h='<tr><th>Tanggal</th><th>Barang</th><th>Supplier</th><th>Keterangan</th><th>Jml</th><th>SN</th></tr>';gKeluar.forEach(r=>{b+=`<tr><td>${r[1]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td></tr>`})}$('#print-head').html(h);$('#print-body').html(b);setTimeout(()=>window.print(),500)}
  </script>
</body>
</html>
